import{r as h,j as e,D as N,k as R,l as w,m as V,bm as q,I as y,B as v,x as d,cv as I,aP as L,aQ as U,aR as k,bn as A,bo as P,bp as T,bq as F,br as S,cJ as C,bs as D,aT as E,c as B}from"./index-C6o_fkGE.js";import{C as Q}from"./content-section-spCXxHNd.js";import{p as O}from"./profile.service-CAaNbiiG.js";function z({isOpen:s,onClose:m,type:p,identifier:n,field:u,value:i,onSuccess:b}){const[x,a]=h.useState(""),[c,l]=h.useState(!1),j=async t=>{var r,f;t.preventDefault(),l(!0);try{(await O.verifyOtp({field:u,value:i,otp:x})).data.success&&(d.success("OTP verified successfully"),b(),m())}catch(g){const X=g;d.error(((f=(r=X.response)==null?void 0:r.data)==null?void 0:f.message)||"Failed to verify OTP")}finally{l(!1)}},o=async()=>{var t,r;try{l(!0),(await O.resendOtp(n)).data.success&&d.success("OTP resent successfully")}catch(f){const g=f;d.error(((r=(t=g.response)==null?void 0:t.data)==null?void 0:r.message)||"Failed to resend OTP")}finally{l(!1)}};return e.jsx(N,{open:s,onOpenChange:m,children:e.jsxs(R,{children:[e.jsxs(w,{children:[e.jsx(V,{children:"Verify OTP"}),e.jsxs(q,{children:["An OTP has been sent to your ",p,": ",n,". Please enter the OTP below to verify."]})]}),e.jsxs("form",{onSubmit:j,className:"space-y-4",children:[e.jsx(y,{type:"text",placeholder:"Enter OTP",value:x,onChange:t=>a(t.target.value),disabled:c}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(v,{type:"button",variant:"outline",onClick:o,disabled:c,children:"Resend OTP"}),e.jsx(v,{type:"submit",disabled:c,children:"Verify OTP"})]})]})]})})}const H=k({email:E().email({message:"Please enter a valid email."}).optional(),phone:E().regex(/^\+91\d{10}$/,{message:"Phone number must be in the format +91XXXXXXXXXX"})});function J(){const s=I(a=>a.user.user),[m,p]=h.useState(!1),[n,u]=h.useState(null),i=L({resolver:U(H),defaultValues:{email:"",phone:""},mode:"onChange"});h.useEffect(()=>{s&&i.reset({email:s.email??"",phone:s.phone??""}),p(!1)},[s,i]);const b=()=>{u(null)},x=async a=>{var c,l,j;try{if(p(!0),a.email!==(s==null?void 0:s.email)||a.phone!==(s==null?void 0:s.phone)){const o=a.email!==(s==null?void 0:s.email)?"email":"phone",t=o==="email"?a.email:a.phone;if(t){const r=await O.requestUpdate({updates:{[o]:t},type:"OTP_REQUIRED"});r.data.success&&((c=r.data.data)!=null&&c.requiresOtp)&&u({isOpen:!0,type:o,identifier:t,field:o,value:t,onSuccess:b})}}else d.info("No changes detected")}catch(o){const t=o;d.error(((j=(l=t.response)==null?void 0:l.data)==null?void 0:j.message)||"Failed to initiate update")}finally{p(!1)}};return e.jsxs(e.Fragment,{children:[n&&e.jsx(z,{isOpen:n.isOpen,onClose:()=>u(null),type:n.type,identifier:n.identifier,field:n.field,value:n.value,onSuccess:n.onSuccess}),m?e.jsx("div",{className:"text-center text-muted-foreground",children:"Loading contact details..."}):e.jsx(A,{...i,children:e.jsxs("form",{id:"contact-form",onSubmit:i.handleSubmit(x),className:"space-y-8",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsx(P,{control:i.control,name:"email",render:({field:a})=>e.jsxs(T,{children:[e.jsx(F,{children:"Email"}),e.jsx(S,{children:e.jsx(y,{type:"email",...a})}),e.jsxs(C,{children:[s!=null&&s.emailVerified?"Email is verified":"Email is not verified",e.jsx("br",{}),"Changing email requires OTP verification and admin approval"]}),e.jsx(D,{})]})}),e.jsx(P,{control:i.control,name:"phone",render:({field:a})=>e.jsxs(T,{children:[e.jsx(F,{children:"Phone Number"}),e.jsx(S,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{value:"+91",disabled:!0,className:"w-16"}),e.jsx(y,{...a})]})}),e.jsxs(C,{children:[s!=null&&s.phoneVerified?"Phone is verified":"Phone is not verified",e.jsx("br",{}),"Changing phone number requires OTP verification and admin approval"]}),e.jsx(D,{})]})})]}),e.jsx(v,{type:"submit",disabled:m,children:"Update contact details"})]})})]})}function M(){return e.jsx(Q,{title:"Contact Information",desc:"Update your contact details and communication preferences.",children:e.jsx(J,{})})}const K=B("/dashboard/profile/contact")({component:M});export{K as Route};
